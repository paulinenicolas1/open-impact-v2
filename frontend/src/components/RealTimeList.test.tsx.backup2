import { render, screen, fireEvent, waitFor, cleanup } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach, afterEach, type Mock } from 'vitest';
import { MantineProvider } from '@mantine/core';
import RealTimeList from './RealTimeList';

// Mock global fetch
global.fetch = vi.fn();

// Mock WebSocket
class MockWebSocket {
  url: string;
  onmessage: ((event: MessageEvent) => void) | null = null;
  send = vi.fn();
  close = vi.fn();

  constructor(url: string) {
    this.url = url;
  }
}

// eslint-disable-next-line @typescript-eslint/no-explicit-any
global.WebSocket = MockWebSocket as any;

const renderWithMantine = (component: React.ReactNode) => {
  return render(<MantineProvider>{component}</MantineProvider>);
};

describe('RealTimeList', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    (global.fetch as Mock).mockResolvedValue({
      json: () => Promise.resolve([]),
    });
  });

  afterEach(() => {
    cleanup();
    vi.restoreAllMocks();
  });

  it('renders the title', () => {
    renderWithMantine(<RealTimeList />);
    expect(screen.getByText('Items (SQLite)')).toBeDefined();
    expect(screen.getByText('Live Updates (WebSocket)')).toBeDefined();
  });

  it('fetches items on mount', async () => {
    const mockItems = [{ id: 1, title: 'Item 1', description: 'Desc 1' }];
    (global.fetch as Mock).mockResolvedValue({
      json: () => Promise.resolve(mockItems),
    });

    renderWithMantine(<RealTimeList />);

    await waitFor(() => {
      expect(global.fetch).toHaveBeenCalledWith('/api/items');
      expect(screen.getByText('Item 1')).toBeDefined();
      expect(screen.getByText('Desc 1')).toBeDefined();
    });
  });

  it('adds a new item', () => {
    (global.fetch as Mock).mockResolvedValueOnce({
      json: () => Promise.resolve([]),
    });

    renderWithMantine(<RealTimeList />);

    const input = screen.getByPlaceholderText('New item title');
    const button = screen.getByRole('button', { name: /add item/i });

    fireEvent.change(input, { target: { value: 'New Item' } });
    fireEvent.click(button);

    expect(global.fetch).toHaveBeenCalledWith(
      '/api/items',
      expect.objectContaining({
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: 'New Item', description: 'Added via frontend' }),
      }),
    );
  });
});
